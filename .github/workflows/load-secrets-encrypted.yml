name: "Load Secrets from GCP and Encrypt"

on:
  workflow_call:
    inputs:
      secrets:
        required: true
        type: string

    secrets:
      service_account:
        required: true
      
      workload_identity_provider:
        required: true
      
      project_id:
        required: true
      
      encryption_key:
        required: true
    
    outputs:
      secrets:
        value: ${{ jobs.load-secrets.outputs.secrets }}
        
jobs:
  load-secrets:
    permissions:
      contents: 'read'
      id-token: 'write'
      
    runs-on: ubuntu-latest

    steps:
      - name: GCP authentication
        uses: google-github-actions/auth@v2
        with:
          service_account: ${{ secrets.service_account }}
          workload_identity_provider: ${{ secrets.workload_identity_provider}}
      
      - id: parse_inputs
        name: Parse multiline input with secret names
        run: |-
          keys=""

          while IFS= read -r line; do
            OUTPUT_NAME=$(echo "$line" | cut -d ':' -f 1)
            SECRET_NAME=$(echo "$line" | cut -d ':' -f 2- | tr -d '\n')
            keys="${keys}${OUTPUT_NAME}:${{ secrets.project_id }}/${FILE_PATH}\n"
          done <<< "${{ inputs.secrets }}"
          
      - id: fetch_secrets
        name: Fetch secrets
        uses: google-github-actions/get-secretmanager-secrets@v2
        with:
          secrets: ${{ steps.parse_inputs.outputs.keys }}
      
      - id: encrypt_secrets
        name: Encrypt secrets
        run: |
          combined_secrets=""

          while IFS= read -r line; do
            key=$(echo "$line" | cut -d ':' -f 1)
            key_upper=$(echo "$key" | tr '[:lower:]' '[:upper:]' | tr '-' '_')
            secret_value_var="FETCH_SECRETS_OUTPUT_$key_upper"
            secret_value="${!secret_value_var}"
            secret_definition="${key}=$(echo -n '$secret_value' | openssl enc -aes-256-cbc -salt -pass pass:'${{ secrets.encryption_key }}' | base64)"
            combined_secrets="${combined_secrets}${secret_definition}\n"
          done <<< "${{ inputs.secrets }}"

          echo -e "combined_secrets=${combined_secrets}" >> "$GITHUB_OUTPUT"
    
    outputs:
      secrets: ${{ steps.encrypt_secrets.outputs.combined_secrets }}